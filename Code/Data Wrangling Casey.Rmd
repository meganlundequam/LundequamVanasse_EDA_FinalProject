---
title: "Data Wrangling"
author: "Megan Lundequam, Same Vanasse and Casey Slaught"
date: "3/30/2022"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(plyr)
library(sf)
library(tidycensus)
library(tidyr)
library(tidyverse)
options(tigris_use_cache = TRUE)

census_api_key("a8cad28557bae7c89aae6ea747549dd4816c6fbd")
```

```{r}
allCensusVariables = load_variables(2020, "acs5", cache=TRUE)
# View(allCensusVariables)

censusVariables = c(
  "Median Family Income" = "B19113_001",
  "Total Population" = "B25026_001" # in occupied housing units
)
```


```{r census}
# American Community Survey (ACS) has data on income, decennial does not
# ACS has yearly data, decennial is every 10 years

getCensusIncomeData = function(geography="county", state="NC") {
  # gets ACS census data from 2010 to 2020
  
  # TODO: add more census variables
  
  dataList = list()
  for (i in 1:11) {
    year = 2009 + i
    data = get_acs(state=state,
                   geography=geography,
                   year=year,
                   geometry = TRUE,
                   variables=censusVariables["Median Family Income"]) %>%
      select(GEOID, NAME, estimate, geometry) %>%
      mutate(Year=year) %>%
      plyr::rename(., c(estimate="MedianHouseholdIncome"))
    
    if (geography == "state") {
      data = data %>% mutate(State=state.abb[match(NAME, state.name)])
    } else if (geography == "county") {
      data = data %>%
        separate(NAME, c("County", "State"), sep=", ", remove=F) %>%
        separate(County, c("CountyShort", NA), sep=" County", remove=F)
    }
    
    dataList[[i]] = data # add it to your list
  }
  
  censusData = do.call(rbind, dataList)
  censusData 
}


geography = "county"
state = "NC"
censusData = getCensusIncomeData(geography=geography, state=state)
# View(censusData)

filePath = paste("../Data/Census/", state, "_", geography, ".geojson", sep="")
st_write(censusData, filePath)

```

```{r}

generatorsNc = read.csv("../Data/Processed/longlat_generators_NC.csv") %>%
  st_as_sf(coords = c('Longitude','Latitude'), crs=4269) %>%
  plyr::rename(., c(County.x="CountyShort")) %>% 
  mutate(FuelType=case_when(
      Energy.Source.1 == "AB" ~ "Solid Renewable Fuel",
      Energy.Source.1 == "BIT" ~ "Coal",
      Energy.Source.1 == "BLQ" ~ "Liquid Renewable Fuel",
      Energy.Source.1 == "DFO" ~ "Petroleum Product",
      Energy.Source.1 == "LFG" ~ "Gaseous Renewable Fuel",
      Energy.Source.1 == "MWH" ~ "Energy Storage",
      Energy.Source.1 == "NG" ~ "Natural Gas",
      Energy.Source.1 == "NUC" ~ "Nuclear",
      Energy.Source.1 == "OBG" ~ "Gaseous Renewable Fuel",
      Energy.Source.1 == "SUN" ~ "Solar",
      Energy.Source.1 == "WAT" ~ "Hydroelectric",
      Energy.Source.1 == "WDS" ~ "Solid Renewable Fuel",
      Energy.Source.1 == "WH" ~ "Waste Heat",
      Energy.Source.1 == "WND" ~ "Wind",
      TRUE ~ "Unknown"
  ))

st_write(generatorsNc, "../Data/Processed/generatorsFuelType.geojson")

```


```{r}

generators = st_read("../Data/Processed/generators.geojson") %>%
  plyr::rename(., c(County.x="CountyShort")) %>% 
  st_transform(4269) %>%
  mutate(FuelType=case_when(
      Energy.Source.1 == "AB" ~ "Solid Renewable Fuel",
      Energy.Source.1 == "BIT" ~ "Coal",
      Energy.Source.1 == "BLQ" ~ "Liquid Renewable Fuel",
      Energy.Source.1 == "DFO" ~ "Petroleum Product",
      Energy.Source.1 == "LFG" ~ "Gaseous Renewable Fuel",
      Energy.Source.1 == "MWH" ~ "Energy Storage",
      Energy.Source.1 == "NG" ~ "Natural Gas",
      Energy.Source.1 == "NUC" ~ "Nuclear",
      Energy.Source.1 == "OBG" ~ "Gaseous Renewable Fuel",
      Energy.Source.1 == "SUN" ~ "Solar",
      Energy.Source.1 == "WAT" ~ "Hydroelectric",
      Energy.Source.1 == "WDS" ~ "Solid Renewable Fuel",
      Energy.Source.1 == "WH" ~ "Waste Heat",
      Energy.Source.1 == "WND" ~ "Wind",
      TRUE ~ "Unknown"
  ))

censusData2020 = censusData %>%
  filter(Year==2020)

st_crs(generators) == st_crs(censusData2020)

generatorsCensus = generators %>%
  st_join(censusData2020, join=st_contains, left=TRUE, largest=TRUE)

generatorsCensus = generatorsCensus %>%
  plyr::rename(., c(Utility.ID.x="Utility.ID",
                    Plant.Name.x="Plant.Name",
                    Utility.Name.x="Utility.Name",
                    CountyShort.x="County.Short")) %>%
  select(-ends_with(".y"), -State.x)

st_write(generatorsCensus, "../Data/Processed/generatorsCensus2020.geojson")

```