---
title: "Data Wrangling"
author: "Megan Lundequam, Same Vanasse and Casey Slaught"
date: "3/30/2022"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(plyr)
library(sf)
library(tidycensus)
library(tidyr)
library(tidyverse)
options(tigris_use_cache = TRUE)

census_api_key("a8cad28557bae7c89aae6ea747549dd4816c6fbd")
```

```{r}
allCensusVariables = load_variables(2020, "acs5", cache=TRUE)
# View(allCensusVariables)

censusVariables = c(
  "Median Family Income" = "B19113_001",
  "Total Population" = "B25026_001" # in occupied housing units
)
```


```{r census}
# American Community Survey (ACS) has data on income, decennial does not
# ACS has yearly data, decennial is every 10 years

getCensusIncomeData = function(geography="county", state="NC") {
  # gets ACS census data from 2010 to 2020
  
  dataList = list()
  for (i in 1:11) {
    year = 2009 + i
    data = get_acs(state=state,
                   geography=geography,
                   year=year,
                   geometry = TRUE,
                   variables=censusVariables["Median Family Income"]) %>%
      select(GEOID, NAME, estimate, geometry) %>%
      mutate(Year=year) %>%
      plyr::rename(., c(estimate="MedianHouseholdIncome"))
    
    if (geography == "state") {
      data = data %>% mutate(State=state.abb[match(NAME, state.name)])
    } else if (geography == "county") {
      data = data %>%
        separate(NAME, c("County", "State"), sep=", ", remove=F) %>%
        separate(County, c("CountyShort", NA), sep=" County", remove=F)
    }
    
    dataList[[i]] = data # add it to your list
  }
  
  censusData = do.call(rbind, dataList)
  censusData 
}


geography = "county"
state = "NC"
censusData = getCensusIncomeData(geography=geography, state=state)
# View(censusData)

filePath = paste("../Data/Census/", state, "_", geography, ".geojson", sep="")
st_write(censusData, filePath)

```

```{r}

generators = st_read("../Data/Processed/generators.geojson") %>%
  plyr::rename(., c(County.x="CountyShort")) %>% 
  st_transform(4269)

censusData2020 = censusData %>%
  filter(Year==2020)

st_crs(generators) == st_crs(censusData2020)

generatorsCensus = generators %>%
  st_join(censusData2020, join=st_contains, left=TRUE, largest=TRUE)

generatorsCensus = generatorsCensus %>% 
  plyr::rename(., c(Utility.ID.x="Utility.ID", 
                    Plant.Name.x="Plant.Name",
                    Utility.Name.x="Utility.Name",
                    CountyShort.x="County.Short")) %>% 
  select(-State.x)


x = st_join(censusData, newGenerators)

ggplot() + 
  geom_sf(aes(color=Technology), alpha=0.8, size=2, data=x) + 


plot(x)


```